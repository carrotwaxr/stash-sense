# Face Recognition Re-evaluation Results (2026-02-12)

## Context

New face recognition database imported from stash-sense-trainer with:
- **107,759 performers**, **277,097 faces** from 5 sources (stashdb, fansdb, theporndb, pmvstash, javstash)
- Proper face alignment (insightface_norm_crop_5point) - previously raw bbox crops
- Correct ArcFace normalization ((x-127.5)/128) - previously /255
- Flip averaging for embeddings

Previous testing (Feb 4-6) used garbage data and yielded ~44% accuracy, ~31% precision at best.

## Test Setup

- 20 stratified test scenes (15x 1080p, 5x 720p)
- 48 expected performers across all scenes
- All scenes classified as "sparse" coverage tier
- Benchmark script: `api/benchmark/reeval.py`
- Full JSON results: `api/benchmark_results/reeval_20260212_064023.json`
- Runtime: 166 minutes

## Phase 1: Baseline (Current Defaults)

| Metric | Value |
|--------|-------|
| Accuracy | 41.7% |
| Precision | 32.8% |
| TP / Expected | 20 / 48 |
| False Positives | 41 |
| 1080p accuracy | 39.5% |
| 720p accuracy | 50.0% |

**Key finding:** Accuracy is roughly the same as old DB (~44%). The alignment/normalization fixes didn't meaningfully improve scene identification. The bottleneck is elsewhere in the pipeline.

## Phase 2: Parameter Sweeps

### max_distance - No impact above 0.5

| max_distance | Accuracy | Precision | TP | FP | FN |
|--------------|----------|-----------|----|----|-----|
| 0.3 | 4.2% | 100.0% | 2 | 0 | 46 |
| 0.4 | 33.3% | 43.2% | 16 | 21 | 32 |
| **0.5** | **41.7%** | **32.8%** | 20 | 41 | 28 |
| 0.6 | 41.7% | 32.8% | 20 | 41 | 28 |
| 0.7 | 41.7% | 32.8% | 20 | 41 | 28 |
| 0.8 | 41.7% | 32.8% | 20 | 41 | 28 |
| 0.9 | 41.7% | 32.8% | 20 | 41 | 28 |

**Insight:** Matches either land below 0.5 or don't land at all. Anything above 0.5 is noise. Can safely tighten to 0.5.

### min_face_size - No impact below 80

| min_face_size | Accuracy | Precision | TP | FP | FN |
|---------------|----------|-----------|----|----|-----|
| 30 | 41.7% | 32.8% | 20 | 41 | 28 |
| 40 | 41.7% | 32.8% | 20 | 41 | 28 |
| 60 | 41.7% | 32.8% | 20 | 41 | 28 |
| 80 | 37.5% | 36.7% | 18 | 31 | 30 |
| 100 | 29.2% | 32.6% | 14 | 29 | 34 |

**Insight:** Below 80px there are no additional small faces being matched. Above 80 loses faces.

### fusion_weights - ArcFace now pulling its weight

| Weights (fn/af) | Accuracy | Precision | TP | FP | FN |
|-----------------|----------|-----------|----|----|-----|
| 0.7/0.3 | 39.6% | 30.6% | 19 | 43 | 29 |
| 0.6/0.4 (old default) | 41.7% | 32.8% | 20 | 41 | 28 |
| **0.5/0.5** | **43.8%** | **33.9%** | **21** | 41 | **27** |
| 0.4/0.6 | 43.8% | 32.8% | 21 | 43 | 27 |
| 0.3/0.7 | 41.7% | 31.2% | 20 | 44 | 28 |

**Insight:** Equal weighting is optimal. This confirms the ArcFace normalization fix is working - it's now a reliable signal. The old 0.6/0.4 bias toward FaceNet was compensating for broken ArcFace.

### matching_mode - Frequency wins

| Mode | Accuracy | Precision | TP | FP | FN |
|------|----------|-----------|----|----|-----|
| frequency | 41.7% | 32.8% | 20 | 41 | 28 |
| hybrid | 39.6% | 33.9% | 19 | 37 | 29 |

**Insight:** Hybrid has marginally better precision (fewer FPs) but loses 1 TP. Frequency is the better default.

### min_appearances - No meaningful impact

| min_appearances | Accuracy | Precision | TP | FP | FN |
|-----------------|----------|-----------|----|----|-----|
| 1 | 41.7% | 32.8% | 20 | 41 | 28 |
| 2 | 41.7% | 32.8% | 20 | 41 | 28 |
| 3 | 39.6% | 47.5% | 19 | 21 | 29 |

**Insight:** 1→2 identical. 3 is a strong precision filter (47.5%) at slight accuracy cost. Could be useful in a "high precision" mode.

### min_unique_frames - THE biggest lever (tied with num_frames)

| min_unique_frames | Accuracy | Precision | TP | FP | FN |
|-------------------|----------|-----------|----|----|-----|
| **1** | **60.4%** | 30.5% | **29** | 66 | **19** |
| 2 (default) | 41.7% | 32.8% | 20 | 41 | 28 |
| 3 | 31.2% | 55.6% | 15 | 12 | 33 |

**Insight:** Dropping from 2→1 recovers 9 TPs (+45% relative) but adds 25 FPs. The unique frame requirement is the binding constraint for many performers who only appear clearly in one frame. Setting to 3 gives 55.6% precision but kills recall.

### min_confidence - Zero impact

| min_confidence | Accuracy | Precision |
|----------------|----------|-----------|
| 0.2 | 41.7% | 32.8% |
| 0.3 | 41.7% | 32.8% |
| 0.35 | 41.7% | 32.8% |
| 0.4 | 41.7% | 32.8% |
| 0.5 | 41.7% | 32.8% |

**Insight:** The confidence threshold is never the binding constraint. All matches that pass the distance filter also pass any confidence threshold we tested.

### num_frames - Strong positive correlation with accuracy

| num_frames | Accuracy | Precision | TP | FP | FN |
|------------|----------|-----------|----|----|-----|
| 20 | 35.4% | 44.7% | 17 | 21 | 31 |
| 40 (default) | 41.7% | 32.8% | 20 | 41 | 28 |
| **60** | **54.2%** | **36.1%** | **26** | 46 | **22** |
| 80 | 60.4% | 30.5% | 29 | 66 | 19 |

**Insight:** Clear linear relationship. Each 20 extra frames adds ~6% accuracy. 60 is the best accuracy/precision/runtime balance: +12.5% accuracy over baseline, precision actually improves to 36.1%, and only 50% more runtime than 40 frames. 80 frames has diminishing returns and drops precision.

## Phase 3: Best-of Combination

Combined best from each sweep:
```
max_distance=0.5, min_face_size=30, fn/af=0.5/0.5,
matching_mode=frequency, min_appearances=1, min_unique_frames=1,
min_confidence=0.2, num_frames=80
```

| Config | Accuracy | Precision | TP | FP | FN |
|--------|----------|-----------|----|----|-----|
| Baseline | 41.7% | 32.8% | 20 | 41 | 28 |
| Best combo | 62.5% | 30.0% | 30 | 70 | 18 |
| **Delta** | **+20.8%** | **-2.8%** | +10 | +29 | -10 |

The gains come primarily from more frames + dropping min_unique_frames to 1.

## Phase 4: Original Scene Re-validation (8 scenes)

| Config | Accuracy | Precision | TP | FP | FN |
|--------|----------|-----------|----|----|-----|
| Default params | 50.0% | 26.7% | 8 | 22 | 8 |
| Best params | 56.2% | 22.5% | 9 | 31 | 7 |

Per-scene:
- Scene 13938 (1080p): 2/2 both configs
- Scene 16342 (1080p): 2/2 both configs
- Scene 30835 (1080p): **0/2 both configs** - stubborn failure
- Scene 3283 (720p): 0/2 → **1/2** (best params recovered one)
- Others: 1/2 both configs

## Phase 5: Gallery Benchmark

10 galleries tested, 5 distance thresholds. Results were nearly identical across all thresholds:

| max_distance | Accuracy | Precision | TP | FP | FN |
|-------------|----------|-----------|----|----|-----|
| All (0.4-0.8) | 78.3% | 3.6% | 18 | 483-488 | 5 |

**Major problem:** Gallery 1062 (1,074 images, 2 expected performers) generated 279-283 FPs alone.
Excluding it, the other 9 galleries had ~204 FPs for 16 TPs (~7.3% precision).

**Root cause:** The "2+ appearances OR single < 0.4" aggregation filter is far too permissive for galleries. Each face in each image produces a top-1 match, and with hundreds of images, random performers easily get 2+ appearances.

**Suggested fixes for gallery aggregation:**
1. Require appearances in minimum % of images (e.g., 10%) not just absolute count
2. Scale minimum appearances with gallery size (e.g., max(2, image_count * 0.05))
3. Use stricter distance thresholds for gallery mode
4. Require the performer to be the top-1 match (not just any match) in multiple images

## Phase 6: Image Benchmark

**Skipped** - no images in the library had tagged performers with StashDB IDs.

## Applied Parameter Changes

Based on these findings, the following "safe" changes were applied:

| Parameter | Old Default | New Default | Rationale |
|-----------|------------|-------------|-----------|
| facenet_weight | 0.6 | 0.5 | ArcFace now working correctly, equal weighting optimal |
| arcface_weight | 0.4 | 0.5 | Same |
| max_distance | 0.7 | 0.5 | Results plateau at 0.5, tighter = less noise |
| num_frames | 40 | 60 | +12.5% accuracy, best precision of elevated frame counts |

**Not changed (needs further investigation):**
- min_unique_frames: kept at 2 (dropping to 1 has huge FP cost)
- min_appearances: kept at 2
- min_confidence: kept at 0.35 (no impact either way)

## Post-Benchmark: Clustering & UI Improvements (same day)

### Problem: Flat Frequency Matching Produces Too Many "Persons"

The frequency matching mode had no concept of face clustering - it threw all face detections into a flat bag and counted performer appearances. A 2-person scene with 38 face detections would produce 34 "persons" in the UI, one per unique performer match.

### Root Cause: L2 Distance on Concatenated Embeddings

The existing `cluster_faces_by_person` used L2 distance on concatenated 1024-dim (FaceNet+ArcFace) embeddings with threshold 0.6. In that high-dimensional space, same-person faces are typically 1.0+ apart in L2 distance, so the 0.6 threshold was far too tight and almost no clustering happened.

### Fix: Clustered Frequency Matching

Implemented a two-stage approach (`clustered_frequency_matching`):

1. **Stage 1 - Clustering**: Group faces by cosine similarity (consistent with Voyager indices) using pre-computed embeddings (avoids recomputing). Threshold 0.6 cosine distance works well.
2. **Stage 2 - Identification**: Within each cluster, run frequency-style matching to identify who each person is. Alternatives shown per cluster.

Also merged clusters with the same best match (existing `merge_clusters_by_match`).

### Results

| Scene | Faces | Old Persons | New Persons | Correct Top Matches |
|-------|-------|-------------|-------------|---------------------|
| 709 | 38 | 34 | **9** (2 dominant: 22 + 5 frames) | Rilynn Rae, Keiran Lee |
| 14650 | 34 | ~30 | **2** | Ella Reese, Tim Gottfrid |
| 19759 | 94 | ~80 | **6** (4 dominant: 27+24+20+17 frames) | Karlie Montana, Madison Ivy, Keiran Lee, Voodoo |

### Additional Improvements

- **Tagged-performer awareness**: Plugin sends existing scene performer StashDB IDs to the API. A small confidence boost (+0.03) is applied to already-tagged performers, and `already_tagged` flag is returned for UI display.
- **"Already tagged" UI state**: Shows "Already tagged on scene" with green badge instead of "Add to Scene" button for performers already on the scene.
- **Grouped UI**: Multi-frame clusters shown prominently; single-frame detections collapsed in a collapsible section.
- **Embedding reuse**: `RecognitionResult` now stores the pre-computed embedding, eliminating redundant embedding generation during clustering.

## Future Investigation Areas

1. **Why is accuracy still ~42% with good embeddings?** The database quality improvement didn't help scenes. Investigate whether the problem is face detection (faces not being detected), frame selection (wrong moments), or matching (wrong performers winning).

2. **Failure analysis on specific performers**: Which of the 28 FN performers are being missed and why? Are they in the database? Are their faces being detected? Are they being matched to wrong performers?

3. **Scene 30835**: Consistently 0/2 across all parameter configs. What's special about this scene?

4. **Gallery aggregation redesign**: Current "2+ appearances" filter is broken for galleries. Need percentage-based or statistical approach.

5. **min_unique_frames=1 with compensating FP filter**: Could we drop to 1 frame but add a stricter distance threshold (e.g., require distance < 0.4 for single-frame matches)?

6. **Image benchmark**: Need to tag some images with performers to enable Phase 6.

7. **Larger scene sample**: 20 scenes with 48 performers is small. Results can shift by 1-2 TPs. Consider running with 50+ scenes for more statistical power.
