# Docker Compose for database builder
#
# Usage:
#   docker-compose -f docker-compose.builder.yml up
#
# For scheduled builds, use cron or Unraid's User Scripts plugin:
#   0 0 * * 0 docker-compose -f /path/to/docker-compose.builder.yml up
#   (runs weekly on Sunday at midnight)

services:
  builder:
    build:
      context: .
      dockerfile: Dockerfile.builder
    container_name: stash-face-builder

    # GPU support for face detection
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      # Required
      - STASHDB_API_KEY=${STASHDB_API_KEY}

      # Optional: StashDB settings
      - STASHDB_URL=https://stashdb.org/graphql
      - MAX_PERFORMERS=200000
      - MAX_IMAGES=5
      - RATE_LIMIT=0.25

      # Optional: Publishing (set PUBLISH=true to auto-release)
      - PUBLISH=${PUBLISH:-false}
      - GH_TOKEN=${GH_TOKEN:-}
      - GH_REPO=${GH_REPO:-}

    volumes:
      # Persistent storage for database output
      - ./data:/app/data

      # Image cache (speeds up incremental builds)
      - ./cache:/app/cache

    # Builder exits when done (not a long-running service)
    restart: "no"
